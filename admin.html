<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Danh sách đăng ký | Hatinh.vip</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --red:    #e02020;
      --gold:   #f5a623;
      --dark:   #1a1a2e;
      --dark2:  #16213e;
      --mid:    #0f3460;
      --light:  #f4f6fb;
      --white:  #ffffff;
      --text:   #2d3748;
      --muted:  #718096;
      --border: #e2e8f0;
      --green:  #22c55e;
      --radius: 14px;
      --shadow: 0 4px 24px rgba(0,0,0,.08);
    }

    html { scroll-behavior: smooth; }
    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .layout { display: flex; min-height: 100vh; }

    .sidebar {
      width: 240px; min-width: 240px;
      background: var(--dark);
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; bottom: 0;
      z-index: 100;
      transition: transform .3s;
    }
    .sidebar-logo {
      padding: 24px 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sidebar-logo a {
      font-size: 1.35rem; font-weight: 900; color: var(--white);
      text-decoration: none; letter-spacing: -.5px;
    }
    .sidebar-logo a span { color: var(--gold); }
    .sidebar-logo small {
      display: block; font-size: .72rem; color: rgba(255,255,255,.4);
      font-weight: 500; margin-top: 3px;
    }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 11px 14px; border-radius: 10px;
      color: rgba(255,255,255,.60); font-size: .9rem; font-weight: 600;
      text-decoration: none; cursor: pointer; border: none;
      background: transparent; width: 100%; text-align: left;
      transition: background .2s, color .2s;
    }
    .nav-item i { width: 18px; text-align: center; font-size: .95rem; }
    .nav-item:hover { background: rgba(255,255,255,.07); color: var(--white); }
    .nav-item.active { background: var(--red); color: var(--white); }
    .nav-item .badge {
      margin-left: auto;
      background: var(--gold); color: var(--dark);
      font-size: .7rem; font-weight: 800;
      padding: 2px 8px; border-radius: 100px;
    }
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .sidebar-footer a {
      display: flex; align-items: center; gap: 8px;
      color: rgba(255,255,255,.40); font-size: .82rem; text-decoration: none;
      transition: color .2s;
    }
    .sidebar-footer a:hover { color: var(--gold); }

    /* ===== MAIN ===== */
    .main {
      margin-left: 240px;
      flex: 1;
      display: flex; flex-direction: column;
      min-height: 100vh;
    }

    /* ===== TOPBAR ===== */
    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 16px 28px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 90;
      box-shadow: 0 1px 4px rgba(0,0,0,.04);
    }
    .topbar-left h1 { font-size: 1.15rem; font-weight: 800; color: var(--dark); }
    .topbar-left p { font-size: .8rem; color: var(--muted); margin-top: 2px; }
    .topbar-right { display: flex; align-items: center; gap: 10px; }
    .topbar-btn {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 9px 16px; border-radius: 8px;
      font-size: .85rem; font-weight: 700;
      cursor: pointer; border: none; transition: .2s;
      font-family: 'Be Vietnam Pro', sans-serif;
    }
    .btn-refresh { background: var(--light); color: var(--text); }
    .btn-refresh:hover { background: var(--border); }
    .btn-export { background: var(--green); color: var(--white); }
    .btn-export:hover { background: #16a34a; }
    .hamburger {
      display: none; background: none; border: none;
      font-size: 1.3rem; color: var(--dark); cursor: pointer;
    }

    /* ===== CONTENT ===== */
    .content { padding: 28px; flex: 1; }

    /* ===== STATS ===== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px 22px;
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      display: flex; align-items: center; gap: 16px;
    }
    .stat-icon {
      width: 48px; height: 48px; min-width: 48px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem;
    }
    .stat-body h3 { font-size: 1.7rem; font-weight: 900; color: var(--dark); line-height: 1; }
    .stat-body p { font-size: .78rem; color: var(--muted); margin-top: 3px; font-weight: 600; }

    /* ===== FILTER / SEARCH BAR ===== */
    .filter-bar {
      background: var(--white);
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    .search-wrap {
      flex: 1; min-width: 200px;
      display: flex; align-items: center; gap: 8px;
      background: var(--light);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 9px 14px;
    }
    .search-wrap i { color: var(--muted); font-size: .9rem; }
    .search-wrap input {
      border: none; background: transparent;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: .9rem; color: var(--text);
      outline: none; width: 100%;
    }
    .search-wrap input::placeholder { color: var(--muted); }
    .filter-select {
      padding: 9px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      background: var(--light);
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: .88rem; color: var(--text);
      outline: none; cursor: pointer;
    }
    .filter-count {
      font-size: .82rem; color: var(--muted); font-weight: 600; white-space: nowrap;
    }

    /* ===== TABLE CARD ===== */
    .table-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      overflow: hidden;
    }
    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%; border-collapse: collapse;
      font-size: .88rem;
    }
    thead th {
      background: var(--light);
      padding: 13px 16px;
      text-align: left;
      font-size: .78rem; font-weight: 800;
      color: var(--muted);
      text-transform: uppercase; letter-spacing: .06em;
      border-bottom: 1.5px solid var(--border);
      white-space: nowrap;
      cursor: pointer; user-select: none;
    }
    thead th:hover { color: var(--dark); }
    thead th i { margin-left: 4px; font-size: .7rem; opacity: .5; }
    tbody tr { border-bottom: 1px solid #f0f4f8; transition: background .15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #fafbff; }
    tbody td { padding: 14px 16px; vertical-align: middle; }

    .td-num { color: var(--muted); font-weight: 700; font-size: .8rem; }
    .td-name { font-weight: 700; color: var(--dark); }
    .td-addr { color: var(--muted); font-size: .84rem; max-width: 220px; }
    .td-phone a {
      color: var(--mid); font-weight: 700; text-decoration: none;
      display: flex; align-items: center; gap: 5px;
    }
    .td-phone a:hover { color: var(--red); }
    .td-note { color: var(--text); max-width: 200px; font-size: .84rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .td-date { white-space: nowrap; color: var(--muted); font-size: .82rem; }
    .td-actions { white-space: nowrap; }

    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 10px; border-radius: 100px;
      font-size: .75rem; font-weight: 700;
    }
    .status-new    { background: #eff6ff; color: #2563eb; }
    .status-done   { background: #f0fdf4; color: #16a34a; }
    .status-skip   { background: #fef9c3; color: #854d0e; }

    .action-btn {
      width: 32px; height: 32px;
      border-radius: 8px; border: none; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: .85rem; transition: .2s;
    }
    .btn-view   { background: #eff6ff; color: #2563eb; }
    .btn-view:hover { background: #dbeafe; }
    .btn-check  { background: #f0fdf4; color: #16a34a; }
    .btn-check:hover { background: #dcfce7; }
    .btn-del    { background: #fff5f5; color: var(--red); }
    .btn-del:hover { background: #fee2e2; }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center; padding: 60px 20px;
    }
    .empty-state i { font-size: 3rem; color: var(--border); display: block; margin-bottom: 14px; }
    .empty-state p { color: var(--muted); font-size: .95rem; }

    /* ===== LOADING ===== */
    .loading-row td { text-align: center; padding: 50px; color: var(--muted); }
    .spinner {
      display: inline-block; width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== PAGINATION ===== */
    .pagination {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 10px;
    }
    .pagination-info { font-size: .82rem; color: var(--muted); }
    .pagination-btns { display: flex; gap: 4px; }
    .page-btn {
      width: 34px; height: 34px;
      border: 1.5px solid var(--border); border-radius: 8px;
      background: var(--white); color: var(--text);
      font-size: .85rem; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: .2s;
    }
    .page-btn:hover:not(:disabled) { border-color: var(--red); color: var(--red); }
    .page-btn.active { background: var(--red); border-color: var(--red); color: var(--white); }
    .page-btn:disabled { opacity: .35; cursor: not-allowed; }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.45); z-index: 999;
      align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white);
      border-radius: 20px;
      width: 100%; max-width: 520px;
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
      animation: fadeUp .25s ease;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .modal-header {
      padding: 22px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 { font-size: 1.05rem; font-weight: 800; color: var(--dark); }
    .modal-close {
      width: 34px; height: 34px; border-radius: 8px;
      background: var(--light); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--muted); font-size: 1rem; transition: .2s;
    }
    .modal-close:hover { background: var(--border); color: var(--dark); }
    .modal-body { padding: 22px 24px; display: flex; flex-direction: column; gap: 14px; }
    .modal-field label {
      font-size: .75rem; font-weight: 800; color: var(--muted);
      text-transform: uppercase; letter-spacing: .07em;
      display: block; margin-bottom: 5px;
    }
    .modal-field p {
      font-size: .97rem; color: var(--dark); font-weight: 600;
      background: var(--light); border-radius: 8px;
      padding: 10px 14px; border: 1.5px solid var(--border);
    }
    .modal-field p.note-text { font-weight: 400; color: var(--text); min-height: 60px; }
    .modal-footer {
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px; border-radius: 8px;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: .88rem; font-weight: 700;
      cursor: pointer; border: none; transition: .2s;
      display: flex; align-items: center; gap: 7px;
    }
    .modal-btn-close { background: var(--light); color: var(--text); }
    .modal-btn-close:hover { background: var(--border); }
    .modal-btn-done  { background: var(--green); color: var(--white); }
    .modal-btn-done:hover { background: #16a34a; }
    .modal-btn-zalo  { background: #0068ff; color: var(--white); }
    .modal-btn-zalo:hover { background: #004fcc; }

    /* ===== TOAST ===== */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--dark); color: var(--white);
      padding: 12px 22px; border-radius: 100px;
      font-size: .88rem; font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,.20);
      z-index: 9999; pointer-events: none;
      opacity: 0; transition: opacity .3s;
      display: flex; align-items: center; gap: 8px;
    }
    .toast.show { opacity: 1; }
    .toast i { color: var(--green); }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
      .hamburger { display: flex; align-items: center; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .content { padding: 16px; }
      .topbar { padding: 14px 16px; }
      .stats-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<div class="layout">

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <a href="index.html">hatinh<span>.vip</span></a>
      <small>Bảng quản trị nội bộ</small>
    </div>
    <nav class="sidebar-nav">
      <a class="nav-item active" href="admin.html">
        <i class="fa-solid fa-list-ul"></i> Danh sách đăng ký
        <span class="badge" id="totalBadge">...</span>
      </a>
      <a class="nav-item" href="index.html" target="_blank">
        <i class="fa-solid fa-arrow-up-right-from-square"></i> Xem Landing Page
      </a>
    </nav>
    <div class="sidebar-footer">
      <a href="index.html">
        <i class="fa-solid fa-arrow-left"></i> Về trang chủ
      </a>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <div class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:12px;">
        <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
          <i class="fa-solid fa-bars"></i>
        </button>
        <div class="topbar-left">
          <h1><i class="fa-solid fa-inbox" style="color:var(--red); margin-right:6px;"></i>Danh sách đăng ký</h1>
          <p>Các quán đã đăng ký làm website qua Hatinh.vip</p>
        </div>
      </div>
      <div class="topbar-right">
        <button class="topbar-btn btn-refresh" onclick="loadData()">
          <i class="fa-solid fa-rotate-right"></i> Làm mới
        </button>
        <button class="topbar-btn btn-export" onclick="exportCSV()">
          <i class="fa-solid fa-file-csv"></i> Xuất CSV
        </button>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content">

      <!-- STATS -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background:#eff6ff; color:#2563eb;">
            <i class="fa-solid fa-inbox"></i>
          </div>
          <div class="stat-body">
            <h3 id="statTotal">–</h3>
            <p>Tổng đăng ký</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#fff0f0; color:var(--red);">
            <i class="fa-solid fa-circle-dot"></i>
          </div>
          <div class="stat-body">
            <h3 id="statNew">–</h3>
            <p>Chưa xử lý</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#f0fdf4; color:var(--green);">
            <i class="fa-solid fa-circle-check"></i>
          </div>
          <div class="stat-body">
            <h3 id="statDone">–</h3>
            <p>Đã liên hệ</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#fefce8; color:#d97706;">
            <i class="fa-solid fa-calendar-day"></i>
          </div>
          <div class="stat-body">
            <h3 id="statToday">–</h3>
            <p>Hôm nay</p>
          </div>
        </div>
      </div>

      <!-- FILTER BAR -->
      <div class="filter-bar">
        <div class="search-wrap">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="searchInput" placeholder="Tìm tên quán, địa chỉ, SĐT..." oninput="onSearch()" />
        </div>
        <select class="filter-select" id="statusFilter" onchange="onSearch()">
          <option value="">Tất cả trạng thái</option>
          <option value="new">Chưa xử lý</option>
          <option value="done">Đã liên hệ</option>
          <option value="skip">Bỏ qua</option>
        </select>
        <select class="filter-select" id="sortFilter" onchange="onSearch()">
          <option value="newest">Mới nhất trước</option>
          <option value="oldest">Cũ nhất trước</option>
          <option value="name">Tên A–Z</option>
        </select>
        <span class="filter-count" id="filterCount"></span>
      </div>

      <!-- TABLE -->
      <div class="table-card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Tên quán / cửa hàng <i class="fa-solid fa-sort"></i></th>
                <th>Địa chỉ</th>
                <th>SĐT / Zalo</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Ngày đăng ký</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr class="loading-row">
                <td colspan="8">
                  <div class="spinner"></div><br />
                  Đang tải dữ liệu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="paginationArea" style="display:none;">
          <span class="pagination-info" id="paginationInfo"></span>
          <div class="pagination-btns" id="paginationBtns"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /layout -->

<!-- ===== MODAL ===== -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <h3><i class="fa-solid fa-store" style="color:var(--red); margin-right:6px;"></i> Chi tiết đăng ký</h3>
      <button class="modal-close" onclick="closeModalDirect()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label><i class="fa-solid fa-store"></i> Tên quán / cửa hàng</label>
        <p id="mName">–</p>
      </div>
      <div class="modal-field">
        <label><i class="fa-solid fa-map-pin"></i> Địa chỉ</label>
        <p id="mAddr">–</p>
      </div>
      <div class="modal-field">
        <label><i class="fa-solid fa-phone"></i> Số điện thoại / Zalo</label>
        <p id="mPhone">–</p>
      </div>
      <div class="modal-field">
        <label><i class="fa-solid fa-pen-to-square"></i> Ghi chú</label>
        <p class="note-text" id="mNote">–</p>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="modal-field">
          <label><i class="fa-solid fa-circle-half-stroke"></i> Trạng thái</label>
          <p id="mStatus">–</p>
        </div>
        <div class="modal-field">
          <label><i class="fa-regular fa-calendar"></i> Ngày đăng ký</label>
          <p id="mDate">–</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-close" onclick="closeModalDirect()">Đóng</button>
      <button class="modal-btn modal-btn-zalo" id="mZaloBtn" onclick="callZalo()">
        <i class="fa-solid fa-phone"></i> Gọi / Zalo
      </button>
      <button class="modal-btn modal-btn-done" id="mDoneBtn" onclick="markDoneFromModal()">
        <i class="fa-solid fa-check"></i> Đánh dấu đã liên hệ
      </button>
    </div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toastMsg"></span></div>

<script>
  // ───────── STATE ─────────
  let allRows    = [];
  let filtered   = [];
  let page       = 1;
  const PER_PAGE = 15;
  let currentId  = null;

  const STATUS_LABEL = {
    new:  'Chưa xử lý',
    done: 'Đã liên hệ',
    skip: 'Bỏ qua'
  };
  const STATUS_CLASS = { new: 'status-new', done: 'status-done', skip: 'status-skip' };

  // ───────── LOAD DATA ─────────
  async function loadData() {
    showLoading();
    try {
      const res  = await fetch('/api/registrations?limit=1000&sort=created_at');
      const json = await res.json();
      allRows = (json.data || []).sort((a, b) => b.created_at - a.created_at);
      updateStats();
      onSearch();
    } catch (e) {
      showError();
    }
  }

  function showLoading() {
    document.getElementById('tableBody').innerHTML = `
      <tr class="loading-row"><td colspan="8">
        <div class="spinner"></div><br />Đang tải dữ liệu...
      </td></tr>`;
    document.getElementById('paginationArea').style.display = 'none';
  }

  function showError() {
    document.getElementById('tableBody').innerHTML = `
      <tr class="loading-row"><td colspan="8" style="color:var(--red)">
        <i class="fa-solid fa-triangle-exclamation" style="font-size:2rem; display:block; margin-bottom:10px;"></i>
        Không thể tải dữ liệu. Vui lòng thử lại.
      </td></tr>`;
  }

  // ───────── STATS ─────────
  function updateStats() {
    const total = allRows.length;
    const now   = new Date();
    const todayStr = now.toDateString();

    const newCount  = allRows.filter(r => !r.status || r.status === 'new').length;
    const doneCount = allRows.filter(r => r.status === 'done').length;
    const todayCount = allRows.filter(r => {
      if (!r.created_at) return false;
      return new Date(r.created_at).toDateString() === todayStr;
    }).length;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statNew').textContent   = newCount;
    document.getElementById('statDone').textContent  = doneCount;
    document.getElementById('statToday').textContent = todayCount;
    document.getElementById('totalBadge').textContent = total;
  }

  // ───────── SEARCH / FILTER ─────────
  function onSearch() {
    const q      = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const sort   = document.getElementById('sortFilter').value;

    filtered = allRows.filter(r => {
      const matchQ = !q ||
        (r.store_name || '').toLowerCase().includes(q) ||
        (r.address    || '').toLowerCase().includes(q) ||
        (r.phone      || '').toLowerCase().includes(q);
      const matchS = !status || (r.status || 'new') === status;
      return matchQ && matchS;
    });

    if (sort === 'newest') filtered.sort((a,b) => (b.created_at||0) - (a.created_at||0));
    if (sort === 'oldest') filtered.sort((a,b) => (a.created_at||0) - (b.created_at||0));
    if (sort === 'name')   filtered.sort((a,b) => (a.store_name||'').localeCompare(b.store_name||'', 'vi'));

    page = 1;
    document.getElementById('filterCount').textContent =
      filtered.length < allRows.length ? `Hiển thị ${filtered.length} / ${allRows.length}` : `${allRows.length} đăng ký`;
    renderTable();
  }

  // ───────── RENDER TABLE ─────────
  function renderTable() {
    const tbody = document.getElementById('tableBody');
    const start = (page - 1) * PER_PAGE;
    const slice = filtered.slice(start, start + PER_PAGE);

    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="8">
          <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <p>Chưa có đăng ký nào. Hãy chia sẻ landing page để thu hút quán đăng ký!</p>
          </div>
        </td></tr>`;
      document.getElementById('paginationArea').style.display = 'none';
      return;
    }

    tbody.innerHTML = slice.map((r, i) => {
      const num     = start + i + 1;
      const status  = r.status || 'new';
      const dateStr = r.created_at ? formatDate(r.created_at) : '–';
      const noteStr = r.note ? escHtml(r.note) : '<span style="color:#ccc">–</span>';
      return `
        <tr>
          <td class="td-num">${num}</td>
          <td class="td-name">${escHtml(r.store_name || '–')}</td>
          <td class="td-addr">${escHtml(r.address || '–')}</td>
          <td class="td-phone">
            <a href="tel:${escHtml(r.phone||'')}" title="Gọi ngay">
              <i class="fa-solid fa-phone-flip"></i>${escHtml(r.phone || '–')}
            </a>
          </td>
          <td class="td-note" title="${escHtml(r.note||'')}">
            ${noteStr}
          </td>
          <td>
            <span class="status-badge ${STATUS_CLASS[status]}">
              ${status === 'new' ? '<i class="fa-solid fa-circle-dot"></i>' :
                status === 'done' ? '<i class="fa-solid fa-circle-check"></i>' :
                '<i class="fa-solid fa-circle-minus"></i>'}
              ${STATUS_LABEL[status]}
            </span>
          </td>
          <td class="td-date">${dateStr}</td>
          <td class="td-actions">
            <button class="action-btn btn-view"  onclick="openModal('${r.id}')" title="Xem chi tiết"><i class="fa-solid fa-eye"></i></button>
            <button class="action-btn btn-check" onclick="markDone('${r.id}')" title="Đánh dấu đã liên hệ" ${status==='done'?'disabled style="opacity:.35;cursor:not-allowed"':''}><i class="fa-solid fa-check"></i></button>
            <button class="action-btn btn-del"   onclick="deleteRow('${r.id}')" title="Xóa"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>`;
    }).join('');

    renderPagination();
    document.getElementById('paginationArea').style.display = '';
  }

  // ───────── PAGINATION ─────────
  function renderPagination() {
    const total = filtered.length;
    const pages = Math.ceil(total / PER_PAGE);
    const start = (page - 1) * PER_PAGE + 1;
    const end   = Math.min(page * PER_PAGE, total);

    document.getElementById('paginationInfo').textContent = `Hiển thị ${start}–${end} / ${total}`;

    const btns = document.getElementById('paginationBtns');
    btns.innerHTML = '';

    // Prev
    const prev = mkPageBtn('<i class="fa-solid fa-chevron-left"></i>', page > 1, () => { page--; renderTable(); });
    btns.appendChild(prev);

    // Page numbers
    const range = pageRange(page, pages);
    range.forEach(p => {
      if (p === '…') {
        const el = document.createElement('button');
        el.className = 'page-btn'; el.disabled = true; el.textContent = '…';
        btns.appendChild(el);
      } else {
        const el = mkPageBtn(p, true, () => { page = p; renderTable(); });
        if (p === page) el.classList.add('active');
        btns.appendChild(el);
      }
    });

    // Next
    const next = mkPageBtn('<i class="fa-solid fa-chevron-right"></i>', page < pages, () => { page++; renderTable(); });
    btns.appendChild(next);
  }

  function mkPageBtn(html, enabled, fn) {
    const el = document.createElement('button');
    el.className = 'page-btn'; el.innerHTML = html;
    if (!enabled) el.disabled = true;
    else el.onclick = fn;
    return el;
  }

  function pageRange(cur, total) {
    if (total <= 7) return Array.from({length: total}, (_, i) => i + 1);
    if (cur <= 4)   return [1, 2, 3, 4, 5, '…', total];
    if (cur >= total - 3) return [1, '…', total-4, total-3, total-2, total-1, total];
    return [1, '…', cur-1, cur, cur+1, '…', total];
  }

  // ───────── MARK DONE ─────────
  async function markDone(id) {
    try {
      await fetch(`/api/registrations/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'done' })
      });
      const row = allRows.find(r => r.id === id);
      if (row) row.status = 'done';
      updateStats();
      onSearch();
      showToast('Đã đánh dấu liên hệ thành công!');
    } catch { showToast('Lỗi! Thử lại nhé.'); }
  }

  async function markDoneFromModal() {
    if (!currentId) return;
    await markDone(currentId);
    const row = allRows.find(r => r.id === currentId);
    if (row) {
      document.getElementById('mStatus').textContent = STATUS_LABEL['done'];
    }
  }

  // ───────── DELETE ─────────
  async function deleteRow(id) {
    if (!confirm('Bạn có chắc muốn xóa đăng ký này không?')) return;
    try {
      await fetch(`/api/registrations/${id}`, { method: 'DELETE' });
      allRows = allRows.filter(r => r.id !== id);
      updateStats();
      onSearch();
      showToast('Đã xóa đăng ký.');
    } catch { showToast('Lỗi khi xóa! Thử lại nhé.'); }
  }

  // ───────── MODAL ─────────
  function openModal(id) {
    currentId = id;
    const r = allRows.find(r => r.id === id);
    if (!r) return;
    const status = r.status || 'new';
    document.getElementById('mName').textContent  = r.store_name  || '–';
    document.getElementById('mAddr').textContent  = r.address     || '–';
    document.getElementById('mPhone').textContent = r.phone       || '–';
    document.getElementById('mNote').textContent  = r.note        || '(Không có ghi chú)';
    document.getElementById('mDate').textContent  = r.created_at ? formatDate(r.created_at) : '–';
    document.getElementById('mStatus').innerHTML  = `<span class="status-badge ${STATUS_CLASS[status]}">${STATUS_LABEL[status]}</span>`;
    document.getElementById('mZaloBtn').setAttribute('data-phone', r.phone || '');
    document.getElementById('mDoneBtn').style.display = status === 'done' ? 'none' : '';
    document.getElementById('modalOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function callZalo() {
    const phone = document.getElementById('mZaloBtn').getAttribute('data-phone');
    if (phone) window.open(`tel:${phone}`, '_self');
  }

  function closeModal(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModalDirect();
  }
  function closeModalDirect() {
    document.getElementById('modalOverlay').classList.remove('open');
    document.body.style.overflow = '';
    currentId = null;
  }

  // ───────── EXPORT CSV ─────────
  function exportCSV() {
    if (!filtered.length) { showToast('Không có dữ liệu để xuất!'); return; }
    const header = ['STT', 'Tên quán', 'Địa chỉ', 'SĐT/Zalo', 'Ghi chú', 'Trạng thái', 'Ngày đăng ký'];
    const rows   = filtered.map((r, i) => [
      i + 1,
      `"${(r.store_name||'').replace(/"/g,'""')}"`,
      `"${(r.address   ||'').replace(/"/g,'""')}"`,
      r.phone || '',
      `"${(r.note      ||'').replace(/"/g,'""')}"`,
      STATUS_LABEL[r.status || 'new'],
      r.created_at ? formatDate(r.created_at) : ''
    ]);
    const csv = [header, ...rows].map(r => r.join(',')).join('\n');
    const bom = '\uFEFF'; // UTF-8 BOM for Excel
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = `hatinh-vip-dangky-${datestamp()}.csv`;
    a.click(); URL.revokeObjectURL(url);
    showToast(`Đã xuất ${filtered.length} dòng CSV!`);
  }

  // ───────── HELPERS ─────────
  function formatDate(ts) {
    const d = new Date(ts);
    return d.toLocaleString('vi-VN', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }
  function datestamp() {
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  }
  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
  }

  // ───────── INIT ─────────
  loadData();
  setInterval(loadData, 60000); // auto-refresh mỗi 60s
</script>
</body>
</html>
